<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<body>
<div class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 animate-fadeIn"
     th:fragment="accountDetails(user)"
     x-data="{
        isLoading: false,
        submitForm() {
            if (this.validateForm()) {
                this.isLoading = true;
                htmx.trigger('#accountForm', 'submit');
            }
        },
        validateForm() {
            const requiredFields = ['name', 'phone', 'address'];
            let isValid = true;

            // Reset errors
            document.querySelectorAll('.text-red-500').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('input').forEach(el => el.classList.remove('border-red-500'));

            requiredFields.forEach(field => {
                const input = document.getElementById(field);
                if (!input.value.trim()) {
                    const errorEl = document.getElementById(field + 'Error');
                    errorEl.textContent = field.charAt(0).toUpperCase() + field.slice(1) + ' is required';
                    errorEl.classList.remove('hidden');
                    input.classList.add('border-red-500');
                    isValid = false;
                }
            });

            return isValid;
        }
     }">
    <div class="bg-gray-800 rounded-xl shadow-2xl max-w-md w-full mx-4 overflow-hidden border border-gray-700">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-cyan-400">Account Details</h2>
                <button @click="$el.closest('[x-data]').remove()" class="text-gray-400 hover:text-gray-200">
                    <svg fill="none" height="20" viewBox="0 0 24 24" width="20" xmlns="http://www.w3.org/2000/svg">
                        <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-linecap="round"
                              stroke-linejoin="round" stroke-width="2"/>
                    </svg>
                </button>
            </div>

            <div class="flex items-center justify-center mb-6">
                <div class="relative group">
                    <img alt="Profile"
                         class="w-24 h-24 rounded-full object-cover border-4 border-gray-700"
                         th:src="${user.imageUrl}"/>
                    <div class="absolute inset-0 bg-black/50 rounded-full opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                        <span class="text-white text-sm">Google Avatar</span>
                    </div>
                </div>
            </div>

            <form @submit.prevent="submitForm()"
                  class="space-y-4"
                  hx-on::after-response="if(event.detail.xhr.status === 200) document.querySelector('[th\:fragment=\'accountDetails\']').remove()"
                  hx-post="/client/account"
                  hx-swap="none"
                  id="accountForm">

                <input th:name="${_csrf.parameterName}" th:value="${_csrf.token}" type="hidden"/>

                <div th:each="field : ${#objects.nullSafe(#fields.all(user), {})}">
                    <div th:if="${!#strings.equalsIgnoreCase(field.name, 'created') &&
                               !#strings.equalsIgnoreCase(field.name, 'updated') &&
                               !#strings.equalsIgnoreCase(field.name, 'imageUrl')}">
                        <label class="block text-sm font-medium text-gray-300 mb-1"
                               th:for="${field.name}"
                               th:text="${#strings.capitalize(field.name)}">
                        </label>
                        <input class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-gray-200"
                               th:disabled="${field.name == 'email'}"
                               th:id="${field.name}"
                               th:name="${field.name}"
                               th:value="${#objects.nullSafe(field.value, '')}"
                               type="text"/>
                        <p class="mt-1 text-sm text-red-500 hidden" th:id="${field.name + 'Error'}"></p>
                    </div>
                </div>

                <div id="errorContainer"></div>

                <div class="mt-6 flex justify-end gap-3">
                    <button @click="$el.closest('[x-data]').remove()"
                            class="px-4 py-2 border border-gray-600 rounded-md text-sm font-medium text-gray-300 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-cyan-500"
                            type="button">
                        Cancel
                    </button>
                    <button :disabled="isLoading"
                            class="px-4 py-2 bg-cyan-600 border border-transparent rounded-md text-sm font-medium text-white hover:bg-cyan-700 focus:outline-none focus:ring-2 focus:ring-cyan-500 disabled:opacity-50"
                            type="submit">
                        <span x-show="!isLoading">Save Changes</span>
                        <span x-show="isLoading">Saving...</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
</body>
</html>